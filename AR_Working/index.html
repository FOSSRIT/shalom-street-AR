<html>

<head>
	<title>AR demo for Shalom Street Museum</title>
	<script type="text/javascript" src="library/polyfill.js"></script>
	<script type="text/javascript" src="library/cv.js"></script>
	<script type="text/javascript" src="library/aruco.js"></script>

	<!--Some of our other stuff here-->
	<script type="text/javascript" src="components/module.js" ></script>
	<script type="text/javascript" src="components/manager.js" ></script>
	<script type="text/javascript" src="components/sprite.js" ></script>
	<script type="text/javascript" src="components/textbox.js"></script>
	<script type="text/javascript" src="components/domElement.js"></script>
	<script type="text/javascript" src="components/HTML5Camera.js"></script>
	<!--Extensions-->
	<script type="text/javascript" src="extensions/touch.js" ></script>
	<script type="text/javascript" src="extensions/jsonLoader.js"></script>

	<script>
		/*------------MAIN-------------------*/

		var video, canvas, ctx, manager;
		var imageData, detector, timeOn;

		function onLoad(){


			//HTML5 dependent.  Ideally, we could use a flash backup or something similar if this isn't supported.
			video = document.getElementById("video");

			canvas = document.getElementById("canvas");
			ctx = canvas.getContext("2d");

			console.log('hey');

			//Initialize the Canvas.
			var scale = 1;
			///* ToDo: Comment out this line (//) to switch on automatic canvas resizing
			var wantedHeightProp = /**window.innerHeight*/400/**/ / /*400;//*/1080;
			var wantedWidthProp = /**window.innerWidth*/400 / /*400;//*/1080;
			scale = (wantedHeightProp < wantedWidthProp)? wantedHeightProp : wantedWidthProp;

			canvas.style.height = 1080 * scale;
			canvas.style.width = 1080 * scale;
			//*/


			manager = Manager(); //Manager should set up its own stinking sub-modules.
			manager.init(canvas, ctx, 1/scale);
			//That's its job, not mine.

			//I'll do it here only because we don't have a functioning github repo for the engine yet.

			//--------------------------SETUP----------------------------------------

			//
			//
			manager.addModule(Sprite(0,0,100, 100))
			manager.addModule(HTML5Camera(0, 0, 1080, 1080, video));
			detector = new AR.Detector();

			console.log('hey');

			//Call this last so we're sure it's only called once.
			manager.setLoad(function(){
				requestAnimationFrame(update);
			});

		}

		function update(){
			manager.draw();
	     	var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
			var markers = detector.detect(imageData);
			console.log(markers);
			drawCorners(markers);
			drawId(markers);
			requestAnimationFrame(update);
		}


		function snapshot(){
	      imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
	    }
	          
	    function drawCorners(markers){
	      var corners, corner, i, j;
	    
	      ctx.lineWidth = 3;

	      for (i = 0; i !== markers.length; ++ i){
	        corners = markers[i].corners;
	        
	        ctx.strokeStyle = "red";
	        ctx.beginPath();
	        
	        for (j = 0; j !== corners.length; ++ j){
	          corner = corners[j];
	          ctx.moveTo(corner.x, corner.y);
	          corner = corners[(j + 1) % corners.length];
	          ctx.lineTo(corner.x, corner.y);
	        }

	        ctx.fill();
	        ctx.stroke();
	        ctx.closePath();
	        
	        ctx.strokeStyle = "green";
	        ctx.fillStyle = "red";
	        ctx.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
	      }
	    }

	    function drawProgressCircle(markers){
	    	var pos = [0,0]
	    	if(markers.length > 0)
	    	{
	    		var corner = markers[0].corners;
	    		for(var i = 0; i < corner.length; i++)
	    		{
	    			pos[0] += corner[i].x/corner.length;
	    			pos[1] += corner[i].y/corner.length;
	    		}

	    		ctx.beginPath();
	    		ctx.arc(pos[0], pos[1], 100, 0, (timeOn/120)*(2 * Math.PI), false);
	    		ctx.lineTo(pos[0], pos[1]);
	    		ctx.lineTo(pos[0]+100, pos[1]);
	    		ctx.fillStyle = "green";
	    		ctx.fill();
	    		ctx.lineWidth = 5;
	    		ctx.strokeStyle = "#003300";
	    		ctx.stroke();
	    		ctx.closePath();
	    	}
	    }

	    function drawId(markers){
	      var corners, corner, x, y, i, j;
	      
	      ctx.strokeStyle = "blue";
	      ctx.lineWidth = 1;
	      
	      for (i = 0; i !== markers.length; ++ i){
	        corners = markers[i].corners;
	        
	        x = Infinity;
	        y = Infinity;
	        
	        for (j = 0; j !== corners.length; ++ j){
	          corner = corners[j];
	          
	          x = Math.min(x, corner.x);
	          y = Math.min(y, corner.y);
	        }

	        ctx.strokeText(markers[i].id, x, y)
	      }
	  }

			//-----------------------------------------------------------------------



			
	// 		//Set canvas width and height.  Why are we doing this here?
	// 		//I guess just because HTML5 is weird?
	// 		canvas.width = parseInt(canvas.style.width);
	// 		canvas.height = parseInt(canvas.style.height);

	// 		//SUPER HTML5 dependent.
	// 		 navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
	// 		if (navigator.getUserMedia){

	// 		function successCallback(stream){
	// 		  if (window.webkitURL) {
	// 		    video.src = window.webkitURL.createObjectURL(stream);
	// 		  } else if (video.mozSrcObject !== undefined) {
	// 		    video.mozSrcObject = stream;
	// 		  } else {
	// 		    video.src = stream;
	// 		  }
	// 		}

	// 		function errorCallback(error){
	// 			alert("can not get camera");
	// 		}

	// 		navigator.getUserMedia({video: true}, successCallback, errorCallback);

	// 		//Load in our library.  I love this already.
	// 		detector = new AR.Detector();
	// 		requestAnimationFrame(tick);
	// 	}
	// }

	// function tick(){
	// 	if(video.readyState === video.HAVE_ENOUGH_DATA) {

	// 		try {
	// 			snapshot();
	// 			var markers = detector.detect(imageData);
	// 			drawCorners(markers);
	// 			drawId(markers);

	// 			//Start running a timer.
	// 			if(markers.length > 0)
	// 			{
	// 				timeOn++;
	// 				drawProgressCircle(markers);

	// 				if(timeOn > 120)
	// 				{
	// 					document.getElementById("trigger").style.visibility = "hidden";
	// 					document.getElementById('triggerText').style.visibility = "visible";
	// 				}
	// 			}
	// 			else
	// 			{
	// 				if(timeOn > 0)
	// 					timeOn--;
	// 				else
	// 					timeOn = 0;

	// 				//timeOn = 0;//(timeon-1 > 0)? timeon - 1 : 0;
	// 			}
	// 		} catch (e) {

	// 		}
	// 	}

	// 	//
	// 	requestAnimationFrame(tick);
	// }

	// function snapshot(){
	//       ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
	//       imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
	//     }
	          
	//     function drawCorners(markers){
	//       var corners, corner, i, j;
	    
	//       ctx.lineWidth = 3;

	//       for (i = 0; i !== markers.length; ++ i){
	//         corners = markers[i].corners;
	        
	//         ctx.strokeStyle = "red";
	//         ctx.beginPath();
	        
	//         for (j = 0; j !== corners.length; ++ j){
	//           corner = corners[j];
	//           ctx.moveTo(corner.x, corner.y);
	//           corner = corners[(j + 1) % corners.length];
	//           ctx.lineTo(corner.x, corner.y);
	//         }

	//         ctx.fill();
	//         ctx.stroke();
	//         ctx.closePath();
	        
	//         ctx.strokeStyle = "green";
	//         ctx.fillStyle = "red";
	//         ctx.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
	//       }
	//     }

	//     function drawProgressCircle(markers){
	//     	var pos = [0,0]
	//     	if(markers.length > 0)
	//     	{
	//     		var corner = markers[0].corners;
	//     		for(var i = 0; i < corner.length; i++)
	//     		{
	//     			pos[0] += corner[i].x/corner.length;
	//     			pos[1] += corner[i].y/corner.length;
	//     		}

	//     		ctx.beginPath();
	//     		ctx.arc(pos[0], pos[1], 100, 0, (timeOn/120)*(2 * Math.PI), false);
	//     		ctx.lineTo(pos[0], pos[1]);
	//     		ctx.lineTo(pos[0]+100, pos[1]);
	//     		ctx.fillStyle = "green";
	//     		ctx.fill();
	//     		ctx.lineWidth = 5;
	//     		ctx.strokeStyle = "#003300";
	//     		ctx.stroke();
	//     		ctx.closePath();
	//     	}
	//     }

	//     function drawId(markers){
	//       var corners, corner, x, y, i, j;
	      
	//       ctx.strokeStyle = "blue";
	//       ctx.lineWidth = 1;
	      
	//       for (i = 0; i !== markers.length; ++ i){
	//         corners = markers[i].corners;
	        
	//         x = Infinity;
	//         y = Infinity;
	        
	//         for (j = 0; j !== corners.length; ++ j){
	//           corner = corners[j];
	          
	//           x = Math.min(x, corner.x);
	//           y = Math.min(y, corner.y);
	//         }

	//         ctx.strokeText(markers[i].id, x, y)
	//       }
	      
	//     }

	    window.onload = onLoad;


	  </script>

		</head>

		<body style="font-family: monospace;">

		  <center>
		    <div style="margin: 10px;"><strong>-= Augmented Reality Marker Detector =-</strong></div>
		    <video id="video" autoplay="true" style="display:none;"></video>
		    <canvas id="canvas" width="1350px" height="1080px" style="width:500px; height:400px;"></canvas> <img id="trigger" src="images/trigger.png" width="400" height="400"/><div id="triggerText" style="visibility:hidden; font-size:250%; width=400px; height=400px;">Welcome to Shalom Street Museum!</div>
		    <div style="margin: 15px;"><strong>Powered by <a href="http://code.google.com/p/js-aruco/">js-aruco</a></strong></div>
		  </center>

		</body>

</html>